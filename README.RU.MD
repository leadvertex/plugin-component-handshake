# LeadVertex handshake плагин
`Leadvertex\Plugin\Components\Handshake\Registration` - компонент, который предназначен для простой
регистрации плагина на LeadVertex. Он использует компонент [lcobucci/jwt]("https://github.com/lcobucci/jwt" "lcobucci/jwt") для генерации и чтения ключей.

## Установка
```shell script
composer require leadvertex/plugin-component-handshake
```

## Использование
Регистрация плагина начинается с отправки регистрационного URI для вашего плагина в LeadVertex.
Запрос, содержащий `JWT` токен, будет отправлен на этот URI.

Получить регистрацию можно за несколько шагов:
- Плагин принимает `JWT` токен в своем конструкторе.
- При создании плагина он проверяет токен, переданный в `JWT` - был ли он отправлен доменом
указонным в переменной среды `LV_PLUGIN_COMPONENT_HANDSHAKE_HOSTNAME`
и действительно ли его схема соответствует схеме, указанной в переменной среды `LV_PLUGIN_COMPONENT_HANDSHAKE_SCHEME`.
Также он проверяет полученный URI плагина - он должен совпадать с текущим URI, указанным в переменной окружения `LV_PLUGIN_SELF_URI`.
- После проверки всех данных плагин отправляет этот токен в LeadVertex. Если LeadVertex подтверждает, что токен действителен - процесс регистрации завершен.
Теперь в вашем приложении вы можете быть уверены, что эта `Registration` действительно пришла от LeadVertex, а LeadVertex, в свою очередь,
может быть уверены, что получил корректный ответ от действующего плагина. Убедитесь, что вы сохраните эту регистрацию для дальнейшего использования при помощи метода `save()`.

Теперь вы можете начать работу с этим плагином, используя подписанный регистрацией токен `JWT`.

## Примеры
Прежде всего, вам нужно настроить некоторые переменные окружения для работы плагина:
```php
$_ENV['LV_PLUGIN_COMPONENT_HANDSHAKE_SCHEME'] = 'https'; // Схема HTTP-соединения. Например 'https'.
$_ENV['LV_PLUGIN_COMPONENT_HANDSHAKE_HOSTNAME'] = 'leadvertex.com'; // Имя хоста соединения. Например 'leadvertex.com'.
$_ENV['LV_PLUGIN_SELF_URI'] = 'https://your.plugin.com/LeadVertexPlugin'; // URI к вашему плагину
```

Вам необходимо получить подписанный токен `JWT` в запросе LeadVertex, который будет отправлен на указанный URI с заголовком `application/json`.
```php
// Получить JWT как json
$jwt = file_get_contents ('php: // input');
```

Затем вам нужно считать токен `JWT` следующим образом:
```PHP
$token = (new Parser())->parse($jwt); // Считывает токен из json-строки
```

В получившимся `JWT` токене необходимо проверить 2 поля:
- `aud` ДОЛЖЕН быть текущим URI вашего плагина.
- `iss` ДОЛЖЕН быть поддоменом leadvertex.com. Схема HTTP для этого URI ДОЛЖНА быть «https».

Если эти поля успешно прошли проверку, вы можете завершить процесс регистрации, отправив этот токен `JWT` в LeadVertex.
С помощью класса `Registration` вы можете сделать это так:
```php
$registration = new Registration(*токен*);
```
При создании класса `Registration` проверяются все условия для полей` iss` и `aud` и формируется URI для последующей отправки токена.\
URI генерируется путем объединения строк `$jwt['iss']` и `$jwt['endpoint']` вместе.

Если процесс регистрации завершился успешно, убедитесь, что вы использовали `$registration->save()`, чтобы сохранить регистрацию для дальнейшего использования.
Дополнительную информацию об этом методе вы можете получить из документации [plugin-component-db](https://github.com/leadvertex/plugin-component-db "plugin-component-db").\
Если процесс регистрации не удался, будет выброшено исключение `HandshakeException`.

Когда ваш плагин получает `JWT` в запросе LeadVertex, он должен загрузить сохраненную регистрацию и получить от нее подписанный токен с помощью метода `getSignedToken()`:
```php
$signatureToken = $registration->getSignedToken($jwt);
```
Именно этот подписанный токен и испольуется для последующих запросов. 

Также вы можете использовать метод `getLVT()` в загруженной модели регистрации, чтобы получить необработанное значение незашифрованного токена:
```php
$rawToken = $registration->getLVT();
```

Теперь вы можете начать работать со своим зарегистрированным плагином и получать запросы с помощью `$signedToken`.